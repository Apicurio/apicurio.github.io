<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Configuring Apicurio Registry storage :: Apicurio Registry</title>
    <link rel="canonical" href="https://www.apicur.io/registry/docs/apicurio-registry-operator/1.0.0/assembly-registry-storage.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
    <link rel="stylesheet" href="../../assets/css/site.css">
    <link rel="stylesheet" href="https://www.apicur.io/css/rhbar.css">
<link rel="stylesheet" href="../../assets/css/search.css">
    <link rel="shortcut icon" href="https://www.apicur.io/images/favicon.ico" type="image/x-icon" integrity="sha384-if9KH+NQ2dMhdrWu+INnJTcvG6riRakUAnbhecX5a7voubrapo7ouFGS+GYZ/N4P" crossorigin="anonymous"/>
  </head>
  <body class="article">
<div id="rhbar">
    <a class="jbdevlogo" href="https://www.jboss.org/projects/about" rel="nofollow" target="_blank"></a>
    <a class="rhlogo" href="https://www.redhat.com/" rel="nofollow" target="_blank"></a>
</div>
<div class="masthead-header">

    <a href="" target="_blank" class="github-corner" aria-label="View source on Github">
        <svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg>
    </a>
    <div class="masthead-logo"></div>
    <div class="masthead-brand"><a href="/">Apicurio Studio</a></div>
    <div class="masthead-menu">
          <input id="search-input" type="text" placeholder="Search docs">
    </div>

    <div class="masthead-menu">
        <ul>
            <li><a href="/contact/">Contact</a></li>
        </ul>
    </div>
</div>
<div class="body">
<div class="nav-container" data-component="apicurio-registry-operator" data-version="0.0.4">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Apicurio Registry Operator</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="assembly-operator-quickstart.html">Apicurio Registry Operator quickstart</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="assembly-operator-installation.html">Installing Apicurio Registry Operator using the OperatorHub</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="assembly-registry-storage.html">Configuring Apicurio Registry storage</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="assembly-registry-maintenance.html">Managing Apicurio Registry deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="assembly-operator-configuration.html">Apicurio Registry Operator configuration reference</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="assembly-operator-dev-quickstart-minikube.html">Apicurio Registry Operator development quickstart on Minikube</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Apicurio Registry Operator</span>
    <span class="version">0.0.4</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Apicurio Registry</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../apicurio-registry/2.4.x/index.html">2.4.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/2.3.x/index.html">2.3.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/2.2.x/index.html">2.2.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/2.1.x/index.html">2.1.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/2.0.x/index.html">2.0.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/1.3.3.Final/index.html">1.3.3.Final</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Apicurio Registry Operator</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../1.0.0/index.html">1.0.0</a>
        </li>
        <li class="version is-current">
          <a href="index.html">0.0.4</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../apicurio-registry/2.4.x/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Apicurio Registry Operator</a></li>
    <li><a href="assembly-registry-storage.html">Configuring Apicurio Registry storage</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">0.0.4</button>
  <div class="version-menu">
    <a class="version" href="../1.0.0/assembly-registry-storage.html">1.0.0</a>
    <a class="version is-current" href="assembly-registry-storage.html">0.0.4</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/Apicurio/apicurio-registry-operator/edit/0.0.x/docs/modules/ROOT/pages/assembly-registry-storage.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Configuring Apicurio Registry storage</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This chapter explains how to configure the available Apicurio Registry storage options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#registry-persistence-options">Apicurio Registry storage options</a></p>
</li>
<li>
<p><a href="#registry-persistence-mem">Configuring Apicurio Registry In-Memory storage using CLI</a></p>
</li>
<li>
<p><a href="#registry-persistence-infinispan">Configuring Apicurio Registry Infinispan storage</a></p>
</li>
<li>
<p><a href="#registry-persistence-kafka-plain">Configuring plain Kafka storage</a></p>
</li>
<li>
<p><a href="#registry-persistence-kafka-streams-plain">Configuring plain Kafka Streams storage with no security</a></p>
</li>
<li>
<p><a href="#registry-persistence-kafka-streams-tls">Configuring Kafka Streams storage with TLS security</a></p>
</li>
<li>
<p><a href="#registry-persistence-kafka-streams-scram">Configuring Kafka Streams storage with SCRAM security</a></p>
</li>
<li>
<p><a href="#registry-persistence-jpa">Configuring Java Persistence API (PostgreSQL) storage</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This chapter mostly focuses on storage configuration procedures for OpenShift using OperatorHub UI.
If you are deploying to Kubernetes, you can use command line tools to perform the equivalent steps.
The Apicurio Registry Operator supports the same configuration options on OpenShift and Kubernetes.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-persistence-options"><a class="anchor" href="#registry-persistence-options"></a>Apicurio Registry storage options</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main decision to make when deploying Apicurio Registry is which storage backend to use.</p>
</div>
<div class="paragraph">
<p>The following storage options are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>In-memory</strong> - data is stored in RAM on each Apicurio Registry node.
This is the easiest deployment to use, but is not recommended for production environment.</p>
</li>
<li>
<p><strong>Infinispan</strong> - data is stored in an embedded Infinispan cache.</p>
</li>
<li>
<p><strong>Apache Kafka</strong> - data is stored using plain Apache Kafka.</p>
</li>
<li>
<p><strong>Apache Kafka Steams</strong> - data is stored using Apache Kafka Streams.
This option is recommended for most production deployments.</p>
</li>
<li>
<p><strong>Java Persistence API</strong> (PostgreSQL) - data is stored in a relational database, in this case PostgreSQL 12+.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Storage requiring installation</div>
<p>The following options require that the storage is already installed as a prerequisite:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Apache Kafka</strong></p>
</li>
<li>
<p><strong>Apache Kafka Streams</strong></p>
</li>
<li>
<p><strong>Java Persistence API</strong> (PostgreSQL)</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="assembly-operator-installation.html" class="page">Installing Apicurio Registry Operator using the OperatorHub</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-persistence-mem"><a class="anchor" href="#registry-persistence-mem"></a>Configuring Apicurio Registry In-Memory storage using CLI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The in-memory storage option uses RAM to store the data on nodes where Apicurio Registry is deployed, and it is the simplest persistence option to use.
The Apicurio Registry Operator will deploy Apicurio Registry in this way if you do not provide any configuration in the <code>ApicurioRegistry</code> CR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apicur.io/v1alpha1
kind: ApicurioRegistry
metadata:
  name: example-apicurioregistry
# spec:
# No config required for dev deployment
# NOTE: In-memory storage option is not suitable for production environment</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have an OpenShift cluster with cluster administrator access.</p>
</li>
<li>
<p>You must have already installed the Apicurio Registry Operator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy the example CR using following commands:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export REF="0.0.4" &&
curl -sSL "https://raw.githubusercontent.com/Apicurio/apicurio-registry-operator/$REF/docs/modules/ROOT/examples/in-memory_cr.yaml" |
kubectl apply -f - -n $NAMESPACE</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This persistence option does not support data distribution across Apicurio Registry nodes.
Therefore, it is only recommended for development environments using a single replica (<code>Pod</code>).
Use embedded Infinispan persistence option when deploying multiple replicas.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-persistence-infinispan"><a class="anchor" href="#registry-persistence-infinispan"></a>Configuring Apicurio Registry Infinispan storage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Apicurio Registry Infinispan storage option uses RAM to store the data on nodes where Apicurio Registry is deployed. This is achieved using an embedded Infinispan in-memory data grid, which also provides data replication between nodes. This configuration is simple, with an optional field to provide a name for the Infinispan cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have an OpenShift cluster with cluster administrator access.</p>
</li>
<li>
<p>You must have already installed the Apicurio Registry Operator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the OpenShift Container Platform web console, log in with cluster administrator privileges.</p>
</li>
<li>
<p>Change to the OpenShift project in which Apicurio Registry is installed. For example, from the <strong>Project</strong> drop-down, select <code>my-project</code>.</p>
</li>
<li>
<p>Click <strong>Installed Operators</strong> &gt; <strong>Apicurio Registry</strong> &gt; <strong>ApicurioRegistry</strong> &gt; <strong>Create ApicurioRegistry</strong>.</p>
</li>
<li>
<p>Use the following example <code>ApicurioRegistry</code> CR:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apicur.io/v1alpha1
kind: ApicurioRegistry
metadata:
  name: example-apicurioregistry
spec:
  configuration:
    persistence: "infinispan"
    infinispan: # Currently, registry uses an embedded version of Infinispan
      clusterName: "example-apicurioregistry"
      # ^ Optional</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-persistence-kafka-plain"><a class="anchor" href="#registry-persistence-kafka-plain"></a>Configuring plain Kafka storage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can configure the Strimzi Operator and Apicurio Registry Operator to use plain Kafka (without Kafka Streams) and with no security.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must install the Apicurio Registry Operator using the OperatorHub or command line.</p>
</li>
<li>
<p>You must install the Strimzi Operator or have Kafka accessible from your OpenShift cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the OpenShift web console, click <strong>Installed Operators</strong>, select the <strong>Strimzi</strong> Operator details, and then the <strong>Kafka</strong> tab.</p>
</li>
<li>
<p>Click <strong>Create Kafka</strong> to provision a new Kafka cluster for Apicurio Registry storage. You can use the default value, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta1
kind: Kafka
metadata:
  name: my-cluster
  namespace: registry-example-kafka
spec:
  kafka:
    version: 2.5.0
    replicas: 3
    listeners:
      plain: {}
      tls: {}
    config:
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      transaction.state.log.min.isr: 2
      log.message.format.version: '2.5'
    storage:
      type: ephemeral
  zookeeper:
    replicas: 3
    storage:
      type: ephemeral
  entityOperator:
    topicOperator: {}
    userOperator: {}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Your OpenShift project namespace might be different.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>When the cluster is ready, open the <strong>Kafka</strong> resource, examine the <code>status</code> block, and copy the <code>bootstrapServers</code> value for later use when deploying Apicurio Registry. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">status:
  conditions:
    ...
  listeners:
    - addresses:
        - host: my-cluster-kafka-bootstrap.registry-example-kafka.svc
          port: 9092
      bootstrapServers: 'my-cluster-kafka-bootstrap.registry-example-kafka.svc:9092'
      type: plain
  ...</code></pre>
</div>
</div>
</li>
<li>
<p>Click the <strong>Kafka Topic</strong> tab, and then <strong>Create Kafka Topic</strong> to create the required <code>global-id-topic</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta1
kind: KafkaTopic
metadata:
  name: global-id-topic
  labels:
    strimzi.io/cluster: my-cluster
  namespace: registry-example-kafka
spec:
  partitions: 2
  replicas: 1
  config:
    retention.ms: 604800000
    segment.bytes: 1073741824</code></pre>
</div>
</div>
</li>
<li>
<p>Change the topic name to <code>global-id-topic</code>, and optionally decrease the partition and replica count to minimum, which is sufficient for an example deployment.</p>
</li>
<li>
<p>Perform the same steps to create the required <code>storage-topic</code> topic.</p>
</li>
<li>
<p>Select the <strong>Apicurio Registry Operator</strong>, and in the <strong>ApicurioRegistry</strong> tab, click <strong>Create ApicurioRegistry</strong>, using the following example, but replace your value in the <code>bootstrapServers</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apicur.io/v1alpha1
kind: ApicurioRegistry
metadata:
  name: example-apicurioregistry
spec:
  configuration:
    persistence: "kafka"
    kafka:
      bootstrapServers: "my-cluster-kafka-bootstrap.registry-example-kafka.svc:9092"</code></pre>
</div>
</div>
</li>
<li>
<p>Wait a few minutes to see the <strong>Route</strong> being created, where you can access the application.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-persistence-kafka-streams-plain"><a class="anchor" href="#registry-persistence-kafka-streams-plain"></a>Configuring plain Kafka Streams storage with no security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can configure the Strimzi Operator and Apicurio Registry Operator to use a default connection with no security.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must install the Apicurio Registry Operator using the OperatorHub or command line.</p>
</li>
<li>
<p>You must install the Strimzi Operator or have Kafka accessible from your OpenShift cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the OpenShift web console, click <strong>Installed Operators</strong>, select the <strong>Strimzi</strong> Operator details, and then the <strong>Kafka</strong> tab.</p>
</li>
<li>
<p>Click <strong>Create Kafka</strong> to provision a new Kafka cluster for Apicurio Registry storage. You can use the default value, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta1
kind: Kafka
metadata:
  name: my-cluster
  namespace: registry-example-streams-plain
spec:
  kafka:
    version: 2.5.0
    replicas: 3
    listeners:
      plain: {}
      tls: {}
    config:
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      transaction.state.log.min.isr: 2
      log.message.format.version: '2.5'
    storage:
      type: ephemeral
  zookeeper:
    replicas: 3
    storage:
      type: ephemeral
  entityOperator:
    topicOperator: {}
    userOperator: {}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Your OpenShift project namespace might be different.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>When the cluster is ready, open the <strong>Kafka</strong> resource, examine the <code>status</code> block, and copy the <code>bootstrapServers</code> value for later use when deploying Apicurio Registry. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">status:
  conditions:
    ...
  listeners:
    - addresses:
        - host: my-cluster-kafka-bootstrap.registry-example-streams-plain.svc
          port: 9092
      bootstrapServers: 'my-cluster-kafka-bootstrap.registry-example-streams-plain.svc:9092'
      type: plain
  ...</code></pre>
</div>
</div>
</li>
<li>
<p>Click the <strong>Kafka Topic</strong> tab, and then <strong>Create Kafka Topic</strong> to create the required <code>global-id-topic</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta1
kind: KafkaTopic
metadata:
  name: global-id-topic
  labels:
    strimzi.io/cluster: my-cluster
  namespace: registry-example-streams-plain
spec:
  partitions: 2
  replicas: 1
  config:
    retention.ms: 604800000
    segment.bytes: 1073741824</code></pre>
</div>
</div>
</li>
<li>
<p>Change the topic name to <code>global-id-topic</code>, and optionally decrease the partition and replica count to minimum, which is sufficient for an example deployment.</p>
</li>
<li>
<p>Perform the same steps to create the required <code>storage-topic</code> topic.</p>
</li>
<li>
<p>Select the <strong>Apicurio Registry Operator</strong>, and in the <strong>ApicurioRegistry</strong> tab, click <strong>Create ApicurioRegistry</strong>, using the following example, but replace your value in the <code>bootstrapServers</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apicur.io/v1alpha1
kind: ApicurioRegistry
metadata:
  name: example-apicurioregistry
spec:
  configuration:
    persistence: "streams"
    streams:
      bootstrapServers: "my-cluster-kafka-bootstrap.registry-example-streams-plain.svc:9092"</code></pre>
</div>
</div>
</li>
<li>
<p>Wait a few minutes to see the <strong>Route</strong> being created, where you can access the application.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-persistence-kafka-streams-tls"><a class="anchor" href="#registry-persistence-kafka-streams-tls"></a>Configuring Kafka Streams storage with TLS security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can configure the Strimzi Operator and Apicurio Registry Operator to use an encrypted Transport Layer Security (TLS) connection.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must install the Apicurio Registry Operator using the OperatorHub or command line.</p>
</li>
<li>
<p>You must install the Strimzi Operator or have Kafka accessible from your OpenShift cluster.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section assumes that the Strimzi Operator is available, however you can use any Kafka deployment.
In that case, you must manually create the Openshift secrets that the Apicurio Registry Operator expects.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the OpenShift web console, click <strong>Installed Operators</strong>, select the <strong>Strimzi</strong> Operator details, and then the <strong>Kafka</strong> tab.</p>
</li>
<li>
<p>Click <strong>Create Kafka</strong> to provision a new Kafka cluster for Apicurio Registry storage.</p>
</li>
<li>
<p>Configure the <code>authorization</code> and <code>tls</code> fields to use TLS authentication for the Kafka cluster, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta1
kind: Kafka
metadata:
  name: my-cluster
  namespace: registry-example-streams-tls
spec:
  kafka:
    authorization:
      type: simple
    version: 2.5.0
    replicas: 3
    listeners:
      plain: {}
      tls:
        authentication:
          type: tls
    config:
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      transaction.state.log.min.isr: 2
      log.message.format.version: '2.5'
    storage:
      type: ephemeral
  zookeeper:
    replicas: 3
    storage:
      type: ephemeral
  entityOperator:
    topicOperator: {}
    userOperator: {}</code></pre>
</div>
</div>
</li>
<li>
<p>Click the <strong>Kafka Topic</strong> tab, and then <strong>Create Kafka Topic</strong> to create the required <code>global-id-topic</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta1
kind: KafkaTopic
metadata:
  name: global-id-topic
  labels:
    strimzi.io/cluster: my-cluster
  namespace: registry-example-streams-plain
spec:
  partitions: 2
  replicas: 1
  config:
    retention.ms: 604800000
    segment.bytes: 1073741824</code></pre>
</div>
</div>
</li>
<li>
<p>Change the topic name to <code>global-id-topic</code>, and optionally decrease the partition and replica count to minimum, which is sufficient for an example deployment.</p>
</li>
<li>
<p>Perform the same steps to create the required <code>storage-topic</code> topic.</p>
</li>
<li>
<p>Create a <strong>Kafka User</strong> resource to configure authentication and authorization for the Apicurio Registry user. For example, in the <code>spec</code> block, you can specify a user name in the <code>metadata</code> section or use the default <code>my-user</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  authentication:
    type: tls
  authorization:
    acls:
      - operation: All
        resource:
          name: '*'
          patternType: literal
          type: topic
      - operation: All
        resource:
          name: '*'
          patternType: literal
          type: cluster
      - operation: All
        resource:
          name: '*'
          patternType: literal
          type: transactionalId
      - operation: All
        resource:
          name: '*'
          patternType: literal
          type: group
    type: simple</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You must configure the authorization specifically for the topics and resources that the Apicurio Registry requires. This is a simple example.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Click <strong>Workloads</strong> and then <strong>Secrets</strong> to find two secrets that Strimzi creates for Apicurio Registry to connect to the Kafka cluster:</p>
<div class="ulist">
<ul>
<li>
<p><code>my-cluster-cluster-ca-cert</code> - contains the PKCS12 truststore for the Kafka cluster</p>
</li>
<li>
<p><code>my-user</code> - contains the user&#8217;s keystore</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The name of the secret can vary based on your cluster or user name.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>If you create the secrets manually, they must contain the following key-value pairs:</p>
<div class="ulist">
<ul>
<li>
<p><strong>my-cluster-ca-cert</strong></p>
<div class="ulist">
<ul>
<li>
<p><code>ca.p12</code> - truststore in PKCS12 format</p>
</li>
<li>
<p><code>ca.password</code> - truststore password</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>my-user</strong></p>
<div class="ulist">
<ul>
<li>
<p><code>user.p12</code> - keystore in PKCS12 format</p>
</li>
<li>
<p><code>user.password</code> - keystore password</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Configure the following example configuration to deploy the Apicurio Registry.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apicur.io/v1alpha1
kind: ApicurioRegistry
metadata:
  name: example-apicurioregistry
spec:
  configuration:
    persistence: "streams"
    streams:
      bootstrapServers: "my-cluster-kafka-bootstrap.registry-example-streams-tls.svc:9093"
      security:
        tls:
          keystoreSecretName: my-user
          truststoreSecretName: my-cluster-cluster-ca-cert</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You must use a different <code>bootstrapServers</code> address than in the plain insecure use case. The address must support TLS connections and is found in the specified <strong>Kafka</strong> resource under the <code>type: tls</code> field.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-persistence-kafka-streams-scram"><a class="anchor" href="#registry-persistence-kafka-streams-scram"></a>Configuring Kafka Streams storage with SCRAM security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can configure the Strimzi Operator and Apicurio Registry Operator to use Salted Challenge Response Authentication Mechanism (SCRAM-SHA-512) for the Kafka cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must install the Apicurio Registry Operator using the OperatorHub or command line.</p>
</li>
<li>
<p>You must install the Strimzi Operator or have Kafka accessible from your OpenShift cluster.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section assumes that Strimzi Operator is available, however you can use any Kafka deployment.
In that case, you must manually create the Openshift secrets that the Apicurio Registry Operator expects.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the OpenShift web console, click <strong>Installed Operators</strong>, select the <strong>Strimzi</strong> Operator details, and then the <strong>Kafka</strong> tab.</p>
</li>
<li>
<p>Click <strong>Create Kafka</strong> to provision a new Kafka cluster for Apicurio Registry storage.</p>
</li>
<li>
<p>Configure the <code>authorization</code> and <code>tls</code> fields to use SCRAM-SHA-512 authentication for the Kafka cluster, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta1
kind: Kafka
metadata:
  name: my-cluster
  namespace: registry-example-streams-tls
spec:
  kafka:
    authorization:
      type: simple
    version: 2.5.0
    replicas: 3
    listeners:
      plain: {}
      tls:
        authentication:
          type: scram-sha-512
    config:
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      transaction.state.log.min.isr: 2
      log.message.format.version: '2.5'
    storage:
      type: ephemeral
  zookeeper:
    replicas: 3
    storage:
      type: ephemeral
  entityOperator:
    topicOperator: {}
    userOperator: {}</code></pre>
</div>
</div>
</li>
<li>
<p>Click the <strong>Kafka Topic</strong> tab, and then <strong>Create Kafka Topic</strong> to create the required <code>global-id-topic</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta1
kind: KafkaTopic
metadata:
  name: global-id-topic
  labels:
    strimzi.io/cluster: my-cluster
  namespace: registry-example-streams-plain
spec:
  partitions: 2
  replicas: 1
  config:
    retention.ms: 604800000
    segment.bytes: 1073741824</code></pre>
</div>
</div>
</li>
<li>
<p>Change the topic name to <code>global-id-topic</code>, and optionally decrease the partition and replica count to minimum, which is sufficient for an example deployment.</p>
</li>
<li>
<p>Perform the same steps to create the required <code>storage-topic</code> topic.</p>
</li>
<li>
<p>Create a <strong>Kafka User</strong> resource to configure SCRAM authentication and authorization for the Apicurio Registry user. For example, in the <code>spec</code> block, see the <code>authentication</code> section.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  authentication:
    type: scram-sha-512
  authorization:
    acls:
      - operation: All
        resource:
          name: '*'
          patternType: literal
          type: topic
      - operation: All
        resource:
          name: '*'
          patternType: literal
          type: cluster
      - operation: All
        resource:
          name: '*'
          patternType: literal
          type: transactionalId
      - operation: All
        resource:
          name: '*'
          patternType: literal
          type: group
    type: simple</code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Workloads</strong> and then <strong>Secrets</strong> to find two secrets that Strimzi creates for Apicurio Registry to connect to the Kafka cluster:</p>
<div class="ulist">
<ul>
<li>
<p><code>my-cluster-cluster-ca-cert</code> - contains the PKCS12 truststore for the Kafka cluster</p>
</li>
<li>
<p><code>my-user</code> - contains the user&#8217;s keystore</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The name of the secret can vary based on your cluster or user name.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>If you create the secrets manually, they must contain the following key-value pairs:</p>
<div class="ulist">
<ul>
<li>
<p><strong>my-cluster-ca-cert</strong></p>
<div class="ulist">
<ul>
<li>
<p><code>ca.p12</code> - the truststore in PKCS12 format</p>
</li>
<li>
<p><code>ca.password</code> - truststore password</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>my-user</strong></p>
<div class="ulist">
<ul>
<li>
<p><code>password</code> - user password</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Configure the following example settings to deploy the Apicurio Registry:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apicur.io/v1alpha1
kind: ApicurioRegistry
metadata:
  name: example-apicurioregistry
spec:
  configuration:
    persistence: "streams"
    streams:
      bootstrapServers: "my-cluster-kafka-bootstrap.registry-example-streams-scram.svc:9093"
      security:
        scram:
          truststoreSecretName: my-cluster-cluster-ca-cert
          user: my-user
          passwordSecretName: my-user</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You must use a different <code>bootstrapServers</code> address than in the plain insecure use case. The address must support TLS connections, and is found in the specified <strong>Kafka</strong> resource under the <code>type: tls</code> field.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-persistence-jpa"><a class="anchor" href="#registry-persistence-jpa"></a>Configuring Java Persistence API (PostgreSQL) storage</h2>
<div class="sectionbody">
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have an OpenShift cluster with cluster administrator access.</p>
</li>
<li>
<p>You must have already installed Apicurio Registry Operator</p>
</li>
<li>
<p>You have a PostgreSQL database reachable from your OpenShift cluster. See <a href="assembly-operator-installation.html" class="page">Installing Apicurio Registry Operator using the OperatorHub</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the OpenShift Container Platform web console, log in with cluster administrator privileges.</p>
</li>
<li>
<p>Change to the OpenShift project in which Apicurio Registry and your PostgreSQL Operator are installed.
For example, from the <strong>Project</strong> drop-down, select <code>my-project</code>.</p>
</li>
<li>
<p>Click <strong>Installed Operators</strong> &gt; <strong>Apicurio Registry</strong> &gt; <strong>ApicurioRegistry</strong> &gt; <strong>Create ApicurioRegistry</strong>.</p>
</li>
<li>
<p>Paste in the following <code>ApicurioRegistry</code> CR, and edit the values for the database <code>url</code> and credentials to match your environment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apicur.io/v1alpha1
kind: ApicurioRegistry
metadata:
  name: example-apicurioregistry
spec:
  configuration:
    persistence: "jpa"
    dataSource:
      url: "jdbc:postgresql://SERVICE_NAME.NAMESPACE.svc:5432/"
      # e.g. url: "jdbc:postgresql://acid-minimal-cluster.my-project.svc:5432/"
      userName: "postgres"
      password: "PASSWORD"
      # ^ Optional</code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Create</strong> and wait for the Apicurio Registry route to be created on OpenShift.</p>
</li>
<li>
<p>Click <strong>Networking</strong> &gt; <strong>Route</strong> to access the new route for the Apicurio Registry web console.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://access.crunchydata.com/documentation/postgres-operator/4.5.0/quickstart/">Crunchy PostgreSQL Operator QuickStart</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright © 2023 Red Hat, Inc. All rights reserved.</p>
</footer>
<script src="../../assets/js/site.js"></script>
<script src="../../assets/js/vendor/lunr.js"></script>
<script src="../../assets/js/vendor/search.js" id="search-script" data-base-path="../.." data-page-path="/apicurio-registry-operator/0.0.4/assembly-registry-storage.html"></script>
<script async src="../../assets/../search-index.js"></script>
<script async src="../../assets/js/vendor/highlight.js"></script>
  </body>
</html>
