<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Managing Apicurio Registry deployment :: Apicurio Registry</title>
    <link rel="canonical" href="https://www.apicur.io/registry/docs/apicurio-registry-operator/1.2.0-dev-v2.6.x/assembly-registry-maintenance.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
    <link rel="stylesheet" href="../../assets/css/site.css">
    <link rel="stylesheet" href="https://www.apicur.io/css/rhbar.css">
<link rel="stylesheet" href="../../assets/css/search.css">
    <link rel="shortcut icon" href="https://www.apicur.io/images/favicon.ico" type="image/x-icon" integrity="sha384-if9KH+NQ2dMhdrWu+INnJTcvG6riRakUAnbhecX5a7voubrapo7ouFGS+GYZ/N4P" crossorigin="anonymous"/>
  </head>
  <body class="article">
<div class="masthead-wrapper">
    <div class="search-box">
        <input id="search-input" type="text" placeholder="Search docs">
    </div>
    <div class="masthead">
        <div class="logo-wrapper">
            <a href="/"><img src="https://www.apicur.io/images/apicurio_headerlogo.png" class="project-logo"
                    title="Apicurio"></a>
        </div>
        <div class="menu-wrapper">
            <ul id="menu" class="menu">
                <li>
                    <a href="/studio/" id="menu-item-studio">Studio</a>
                </li>
                <li>
                    <a href="/registry/" id="menu-item-registry">Registry</a>
                </li>
                <li>
                    <a href="/datamodels/">Data Models</a>
                </li>
                <li>
                    <a href="/apicurito/">Apicurito</a>
                </li>
                <li>
                    <a href="/blog/">Blog</a>
                </li>
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                <li>
                    <a href="https://github.com/apicurio">Fork</a>
                </li>
            </ul>
        </div>
    </div>
</div>
<script>
    var currentURL = window.location.href;
    var studioAnchor = document.getElementById("menu-item-studio");
    var registryAnchor = document.getElementById("menu-item-registry");

    if (currentURL.includes("studio")) {
        studioAnchor.classList.add("active");
    } else if (currentURL.includes("registry")) {
        registryAnchor.classList.add("active");
    }
</script>
<div class="body">
<div class="nav-container" data-component="apicurio-registry-operator" data-version="1.0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Apicurio Registry Operator</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="assembly-operator-quickstart.html">Apicurio Registry Operator quickstart</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="assembly-operator-installation.html">Installing Apicurio Registry Operator using the OperatorHub</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="assembly-registry-storage.html">Configuring Apicurio Registry storage</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="assembly-registry-maintenance.html">Managing Apicurio Registry deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="assembly-operator-configuration.html">Apicurio Registry Operator configuration reference</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Apicurio Registry Operator</span>
    <span class="version">1.0.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Apicurio Registry</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../apicurio-registry/3.1.x/index.html">3.1.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/3.0.x/index.html">3.0.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/2.6.x/index.html">2.6.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/2.5.x/index.html">2.5.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/2.4.x/index.html">2.4.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/2.3.x/index.html">2.3.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/2.2.x/index.html">2.2.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/2.1.x/index.html">2.1.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/2.0.x/index.html">2.0.x</a>
        </li>
        <li class="version">
          <a href="../../apicurio-registry/1.3.3.Final/index.html">1.3.3.Final</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Apicurio Registry Operator</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../1.2.0-dev-v2.6.x/index.html">1.2.0-dev-v2.6.x</a>
        </li>
        <li class="version">
          <a href="../1.1.1-v2.5.9.final/index.html">1.1.1-v2.5.9.final</a>
        </li>
        <li class="version">
          <a href="../1.1.0-v2.4.12.final/index.html">1.1.0-v2.4.12.final</a>
        </li>
        <li class="version is-current">
          <a href="index.html">1.0.0</a>
        </li>
        <li class="version">
          <a href="../0.0.4/index.html">0.0.4</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../apicurio-registry/3.1.x/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Apicurio Registry Operator</a></li>
    <li><a href="assembly-registry-maintenance.html">Managing Apicurio Registry deployment</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">1.0.0</button>
  <div class="version-menu">
    <a class="version" href="../1.2.0-dev-v2.6.x/assembly-registry-maintenance.html">1.2.0-dev-v2.6.x</a>
    <a class="version" href="../1.1.1-v2.5.9.final/assembly-registry-maintenance.html">1.1.1-v2.5.9.final</a>
    <a class="version" href="../1.1.0-v2.4.12.final/assembly-registry-maintenance.html">1.1.0-v2.4.12.final</a>
    <a class="version is-current" href="assembly-registry-maintenance.html">1.0.0</a>
    <a class="version" href="../0.0.4/assembly-registry-maintenance.html">0.0.4</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/Apicurio/apicurio-registry-operator/blob/1.0.0-v2.0.0.final/docs/modules/ROOT/pages/assembly-registry-maintenance.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Managing Apicurio Registry deployment</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This chapter explains how to manage your Apicurio Registry deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#registry-security-keycloak">Securing Apicurio Registry API endpoints and web console using Keycloak</a></p>
</li>
<li>
<p><a href="#manage-registry-environment-variables">Managing Apicurio Registry environment variables</a></p>
</li>
<li>
<p><a href="#registry-liveness-and-readiness">Apicurio Registry liveness and readiness environment variables</a></p>
</li>
<li>
<p><a href="#registry-https-in-cluster">Configuring an HTTPS connection to Apicurio Registry from inside the OpenShift cluster</a></p>
</li>
<li>
<p><a href="#registry-https-outside-cluster">Configuring an HTTPS connection to Apicurio Registry from outside the OpenShift cluster</a></p>
</li>
<li>
<p><a href="#registry-sql-backup">Backing up Apicurio Registry PostgreSQL storage</a></p>
</li>
<li>
<p><a href="#registry-sql-restore">Restoring Apicurio Registry PostgreSQL storage</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-security-keycloak"><a class="anchor" href="#registry-security-keycloak"></a>Securing Apicurio Registry API endpoints and web console using Keycloak</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following procedure shows how to configure Apicurio Registry deployment to be protected by Keycloak.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The example configuration in this procedure is intended only for development and testing.
In order to keep the procedure simple, it does not use HTTPS and other defenses recommended for a production environment.
Please follow the Keycloak documentation for more details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Apicurio Registry supports following user roles:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Supported user roles</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Capabilities</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sr-admin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No restrictions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sr-developer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Can not modify global rules, perform import or export, and use <code>/admin</code> REST API endpoint</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sr-readonly</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Can not modify artifacts or rules</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is a related configuration option in <code>ApicurioRegistry</code> CRD that can be used to set the web console to read-only mode.
However, this configuration does not affect the REST API.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have already installed the Apicurio Registry Operator.</p>
</li>
<li>
<p>You must install the Keycloak Operator or have Keycloak accessible from your OpenShift cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the OpenShift web console, click <strong>Installed Operators</strong>, select the <strong>Keycloak</strong> Operator details, and then the <strong>Keycloak</strong> tab.</p>
</li>
<li>
<p>Click <strong>Create Keycloak</strong> to provision a new Keycloak instance for securing a Apicurio Registry deployment. You can use the default value, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: keycloak.org/v1alpha1
kind: Keycloak
metadata:
  name: example-keycloak
  labels:
    app: sso
spec:
  instances: 1
  externalAccess:
    enabled: True
  podDisruptionBudget:
    enabled: True</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is a known Keycloak Operator issue <a href="https://issues.redhat.com/browse/KEYCLOAK-17532" class="bare">https://issues.redhat.com/browse/KEYCLOAK-17532</a> which contains a workaround you may need, until it is fully resolved.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>When the cluster is ready, click <strong>Networking</strong> &gt; <strong>Route</strong> to access the new route to the Keycloak instance. Copy the auth URL value for later use when deploying Apicurio Registry.</p>
</li>
<li>
<p>Click the <strong>Keycloak Realm</strong> tab, and then <strong>Create Keycloak Realm</strong> to create a <code>registry</code> example realm:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: keycloak.org/v1alpha1
kind: KeycloakRealm
metadata:
  name: registry-keycloakrealm
spec:
  instanceSelector:
    matchLabels:
      app: sso
  realm:
    displayName: Registry
    enabled: true
    id: registry
    realm: registry
    sslRequired: none
    roles:
      realm:
        - name: sr-admin
        - name: sr-developer
        - name: sr-readonly
    clients:
      - clientId: registry-client-ui
        implicitFlowEnabled: true
        redirectUris:
          - '*'
        standardFlowEnabled: true
        webOrigins:
          - '*'
        publicClient: true
      - clientId: registry-client-api
        implicitFlowEnabled: true
        redirectUris:
          - '*'
        standardFlowEnabled: true
        webOrigins:
          - '*'
        publicClient: true
    users:
      - credentials:
          - temporary: false
            type: password
            value: changeme
        enabled: true
        realmRoles:
          - sr-admin
        username: registry-admin
      - credentials:
          - temporary: false
            type: password
            value: changeme
        enabled: true
        realmRoles:
          - sr-developer
        username: registry-developer
      - credentials:
          - temporary: false
            type: password
            value: changeme
        enabled: true
        realmRoles:
          - sr-readonly
        username: registry-user</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>KeycloakRealm</code> resource has to be customized with values suitable for your environment, if you are deploying to production.
You can also create and manage realms using the web console of Keycloak instance.</p>
</div>
</li>
<li>
<p>If your cluster does not have a valid HTTPS certificate configured, you can create the following HTTP <code>Service</code> and <code>Ingress</code> resources as a temporary workaround:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">﻿apiVersion: v1
kind: Service
metadata:
  name: keycloak-http
  labels:
    app: keycloak
spec:
  ports:
    - name: keycloak-http
      protocol: TCP
      port: 8080
      targetPort: 8080
  selector:
    app: keycloak
    component: keycloak
  type: ClusterIP
  sessionAffinity: None
status:
  loadBalancer: {}
---
﻿apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: keycloak-http
  labels:
    app: keycloak
spec:
  rules:
    - host: keycloak-http.local
      http:
        paths:
          - path: /
            pathType: ImplementationSpecific
            backend:
              serviceName: keycloak-http
              servicePort: 8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify the <code>host</code> value to create a route accessible for the Apicurio Registry user, and use it instead of the HTTPS route created by Keycloak Operator.</p>
</div>
</li>
<li>
<p>Select the <strong>Apicurio Registry Operator</strong>, and in the <strong>ApicurioRegistry</strong> tab, click <strong>Create ApicurioRegistry</strong>, using the following example, but replace your values in the <code>keycloak</code> section.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: registry.apicur.io/v1
kind: ApicurioRegistry
metadata:
  name: example-apicurioregistry
spec:
  configuration:
    security:
      keycloak:
        url: "http://keycloak-http-&lt;namespace&gt;.apps.&lt;cluster host&gt;/auth"
        # ^ Required
        # Keycloak server URL, must end with `/auth`.
        # Use an HTTP URL in development.
        realm: "registry"
        # apiClientId: "registry-client-api"
        # ^ Optional (default value)
        # uiClientId: "registry-client-ui"
        # ^ Optional (default value)</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="manage-registry-environment-variables"><a class="anchor" href="#manage-registry-environment-variables"></a>Managing Apicurio Registry environment variables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apicurio Registry Operator manages most common Apicurio Registry configuration, but there are some options that you can adjust manually. You can update these by setting an environment variable on the Apicurio Registry <code>Deployment</code> resource. If the specific configuration option is not available in the <code>ApicurioRegistry</code> CR, you can use an environment variable to adjust it.</p>
</div>
<div class="dlist">
<div class="title">Procedure</div>
<dl>
<dt class="hdlist1">OpenShift web console</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Select the <strong>Installed Operators</strong> tab, and then the <strong>Red Hat Integration - Apicurio Registry Operator</strong>.</p>
</li>
<li>
<p>On the <strong>ApicurioRegistry</strong> tab, click the <code>ApicurioRegistry</code> CR for your Apicurio Registry deployment.</p>
</li>
<li>
<p>On the main overview page, view the <strong>managedResources</strong> section, which contains the name of the <code>Deployment</code> managed by the Operator to deploy your Apicurio Registry instance.</p>
</li>
<li>
<p>Find that <code>Deployment</code> in the <strong>Workloads</strong> &gt; <strong>Deployments</strong> in the left menu.</p>
</li>
<li>
<p>Select the <code>Deployment</code> with the correct name, and select the <strong>Environment</strong> tab.</p>
</li>
<li>
<p>You can add or modify your environment variable to the <strong>Single values (env)</strong> section.</p>
</li>
<li>
<p>Click <strong>Save</strong> at the bottom.</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">OpenShift CLI</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Select the project where Apicurio Registry is installed.</p>
</li>
<li>
<p>Run <code>oc get apicurioregistry</code> to get the list of <code>ApicurioRegistry</code> CRs</p>
</li>
<li>
<p>Run <code>oc describe</code> on the CR representing the Apicurio Registry instance that you want to configure.</p>
</li>
<li>
<p>View <strong>managedResources</strong> in the <strong>status</strong> section.</p>
</li>
<li>
<p>Find that <code>Deployment</code> and enter <code>oc edit</code>.</p>
</li>
<li>
<p>Add or modify the environment variable in the <code>spec.template.spec.containers[0].env</code> section.</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-liveness-and-readiness"><a class="anchor" href="#registry-liveness-and-readiness"></a>Apicurio Registry liveness and readiness environment variables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apicurio Registry provides readiness and liveness probes for OpenShift to ensure application health. These settings are configured to use reasonable defaults, but if you want to adjust them, this section provides details on the environment variables that you can configure.</p>
</div>
<div class="paragraph">
<p>OpenShift liveness and readiness errors are explained as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Liveness error</strong> - the application cannot make progress, OpenShift restarts the failing pod.</p>
</li>
<li>
<p><strong>Readiness error</strong> - the application is not ready, for example, it is overwhelmed by requests. OpenShift stops sending requests to the pod for the time the probe fails. If other pods are OK, they still receive requests.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Apicurio Registry liveness environment variables</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Value type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LIVENESS_ERROR_THRESHOLD</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Positive integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of liveness errors that  can occur before the liveness probe fails.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LIVENESS_COUNTER_RESET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Positive integer, seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Period in which the <em>threshold</em> number of errors  must occur. For example, if this value is <code>60</code> and the threshold is <code>1</code>, the check fails after two errors occur in 1 minute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LIVENESS_STATUS_RESET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Positive integer, seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that must elapse without any more errors for the liveness probe to reset to <em>OK</em> status. Because OpenShift restarts the pod that fails the liveness check, this value, unlike readiness, does not actually affect what happens.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LIVENESS_ERRORS_IGNORED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma-separated list of fully qualified exception class names.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of errors that are ignored for liveness checking purposes.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Apicurio Registry readiness environment variables</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Value type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>READINESS_ERROR_THRESHOLD</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Positive integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of readiness errors that  can occur before the readiness probe fails.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>READINESS_COUNTER_RESET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Positive integer, seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Period in which the threshold number of errors must occur. For example, if this value is 60 and the threshold is 1, the check fails  after two errors occur in 1 minute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>READINESS_STATUS_RESET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Positive integer, seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that must elapse without any more errors for the readiness probe to reset to OK status. In practice, this value means how long the pod remains in an unready state until it returns to normal operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>READINESS_TIMEOUT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">positive integer, seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The readiness system tracks the timeout of two operations: how long it takes for a storage request to complete, and how long it takes for an HTTP REST API request to return a response. If the operation takes more time, it is counted as a readiness error. This value controls those timeouts.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="registry-https-in-cluster"><a class="anchor" href="#registry-https-in-cluster"></a>Configuring an HTTPS connection to Apicurio Registry from inside the OpenShift cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following procedure shows how to configure Apicurio Registry deployment to expose a port for HTTPS connections from inside the OpenShift cluster.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This kind of connection is not directly available outside of the cluster.
Routing is based on hostname, which is encoded in the case of an HTTPS connection.
Therefore, edge termination or other configuration is still needed.
See <a href="#registry-https-outside-cluster">Configuring an HTTPS connection to Apicurio Registry from outside the OpenShift cluster</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have already installed the Apicurio Registry Operator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Generate a <code>keystore</code> with a self-signed certificate.
You can skip this step if you are using your own certificates.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">keytool -genkey -trustcacerts -keyalg RSA -keystore registry-keystore.jks -storepass password</code></pre>
</div>
</div>
</li>
<li>
<p>Create a new secret to hold the keystore and keystore password.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the left navigation menu of the OpenShift web console, click <strong>Workloads</strong> &gt; <strong>Secrets</strong> &gt; <strong>Create Key/Value Secret</strong>.</p>
</li>
<li>
<p>Use the following values:<br>
Name: <code>registry-keystore</code><br>
Key 1: <code>keystore.jks</code><br>
Value 1: <em>registry-keystore.jks</em> (uploaded file)<br>
Key 2: <code>password</code><br>
Value 2: <em>password</em></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you encounter a <code>java.io.IOException: Invalid keystore format</code>, the upload of the binary file did not work properly.
As an alternative, encode the file as a base64 string using <code>cat registry-keystore.jks | base64 -w0 &gt; data.txt</code> and edit the <strong>Secret</strong> resource as yaml to manually add the encoded file.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Edit the <strong>Deployment</strong> resource of the Apicurio Registry instance.
You can find the correct name in a status field of the Apicurio Registry Operator.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add the keystore secret as a volume:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">template:
  spec:
    volumes:
    - name: registry-keystore-secret-volume
      secret:
      secretName: registry-keystore</code></pre>
</div>
</div>
</li>
<li>
<p>Add a volume mount:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">volumeMounts:
  - name: registry-keystore-secret-volume
    mountPath: /etc/registry-keystore
    readOnly: true</code></pre>
</div>
</div>
</li>
<li>
<p>Add <code>JAVA_OPTIONS</code> and <code>KEYSTORE_PASSWORD</code> environment variables:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: KEYSTORE_PASSWORD
  valueFrom:
    secretKeyRef:
      name: registry-keystore
      key: password
- name: JAVA_OPTIONS
    value: &gt;-
     -Dquarkus.http.ssl.certificate.key-store-file=/etc/registry-keystore/keystore.jks
     -Dquarkus.http.ssl.certificate.key-store-file-type=jks
     -Dquarkus.http.ssl.certificate.key-store-password=$(KEYSTORE_PASSWORD)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Order is important when using string interpolation.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Enable the HTTPS port:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">ports:
  - containerPort: 8080
    protocol: TCP
  - containerPort: 8443
    protocol: TCP</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Edit the <strong>Service</strong> resource of the Apicurio Registry instance.
You can find the correct name in a status field of the Apicurio Registry Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">ports:
  - name: http
    protocol: TCP
    port: 8080
    targetPort: 8080
  - name: https
    protocol: TCP
    port: 8443
    targetPort: 8443</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the connection is working:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Connect into a pod on the cluster using SSH (you can use the Apicurio Registry pod):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc rsh -n default example-apicurioregistry-deployment-vx28s-4-lmtqb</code></pre>
</div>
</div>
</li>
<li>
<p>Find the cluster IP of the Apicurio Registry pod from the <strong>Service</strong> resource (see the <strong>Location</strong> column in the web console).
Afterwards, execute a test request (we are using self-signed certificate, so an insecure flag is required):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -k https://172.30.209.198:8443/health
[...]</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-https-outside-cluster"><a class="anchor" href="#registry-https-outside-cluster"></a>Configuring an HTTPS connection to Apicurio Registry from outside the OpenShift cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following procedure shows how to configure Apicurio Registry deployment to expose an HTTPS edge-terminated route for connections from outside the OpenShift cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have already installed the Apicurio Registry Operator.</p>
</li>
<li>
<p>Read the <a href="https://docs.openshift.com/container-platform/latest/networking/routes/secured-routes.html">OpenShift documentation for creating secured routes</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add a second <strong>Route</strong> in addition to the HTTP route created by the Apicurio Registry Operator.
See the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Route
apiVersion: route.openshift.io/v1
metadata:
  [...]
  labels:
    app: example-apicurioregistry
    [...]
spec:
  host: example-apicurioregistry-default.apps.example.com
  to:
    kind: Service
    name: example-apicurioregistry-service-9whd7
    weight: 100
  port:
    targetPort: 8080
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
  wildcardPolicy: None</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Make sure the <code>insecureEdgeTerminationPolicy: Redirect</code> configuration property is set.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you do not specify a certificate, OpenShift will use a default.
You can alternatively generate a custom self-signed certificate using the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">openssl genrsa 2048 &gt; host.key &amp;&amp;
openssl req -new -x509 -nodes -sha256 -days 365 -key host.key -out host.cert</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then create a route using the OpenShift CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create route edge \
  --service=example-apicurioregistry-service-9whd7 \
  --cert=host.cert --key=host.key \
  --hostname=example-apicurioregistry-default.apps.example.com \
  --insecure-policy=Redirect \
  -n default</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-sql-backup"><a class="anchor" href="#registry-sql-backup"></a>Backing up Apicurio Registry PostgreSQL storage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using storage in a PostgreSQL database, you must ensure that the data stored by Apicurio Registry is backed up regularly.</p>
</div>
<div class="paragraph">
<p><a href="https://www.postgresql.org/docs/12/backup-dump.html">SQL Dump</a> is a simple procedure that works with any PostgreSQL installation.
This uses the <a href="https://www.postgresql.org/docs/12/app-pgdump.html">pg_dump</a> utility to generate a file with SQL commands that you can use to recreate the database in the same state that it was in at the time of the dump.</p>
</div>
<div class="paragraph">
<p><code>pg_dump</code> is a regular PostgreSQL client application, which you can execute from any remote host that has access to the database.
Like any other client, the operations that can perform are limited to the user permissions.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Use the <code>pg_dump</code> command to redirect the output to a file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"> $ pg_dump dbname &gt; dumpfile</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can specify the database server that <code>pg_dump</code> connects to using the <code>-h host</code> and <code>-p port</code> options.</p>
</div>
</li>
<li>
<p>You can reduce large dump files using a compression tool, such as gzip, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"> $ pg_dump dbname | gzip &gt; filename.gz</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For details on client authentication, see the <a href="https://www.postgresql.org/docs/12/client-authentication.html">PostgreSQL documentation</a>.</p>
</li>
<li>
<p>For details on importing and exporting registry content, see <a href="https://www.apicur.io/registry/docs/apicurio-registry/2.0.0.Final/getting-started/assembly-managing-registry-artifacts-api.html">Managing Apicurio Registry content using the REST API</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registry-sql-restore"><a class="anchor" href="#registry-sql-restore"></a>Restoring Apicurio Registry PostgreSQL storage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can restore SQL Dump files created by <code>pg_dump</code> using the <code>psql</code> utility.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have already backed up your PostgreSQL datbase using <code>pg_dump</code>. See <a href="#registry-sql-backup">Backing up Apicurio Registry PostgreSQL storage</a>.</p>
</li>
<li>
<p>All users who own objects or have permissions on objects in the dumped database must already exist.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enter the following command to create the database:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"> $ createdb -T template0 dbname</code></pre>
</div>
</div>
</li>
<li>
<p>Enter the following command to restore the SQL dump</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"> $ psql dbname &lt; dumpfile</code></pre>
</div>
</div>
</li>
<li>
<p>Run <a href="https://www.postgresql.org/docs/12/sql-analyze.html">ANALYZE</a> on each database so the query optimizer has useful statistics.</p>
</li>
</ol>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright © 2024 Red Hat, Inc. All rights reserved.</p>
</footer>
<script src="../../assets/js/site.js"></script>
<script src="../../assets/js/vendor/lunr.js"></script>
<script src="../../assets/js/vendor/search.js" id="search-script" data-base-path="../.." data-page-path="/apicurio-registry-operator/1.0.0/assembly-registry-maintenance.html"></script>
<script async src="../../assets/../search-index.js"></script>
<script async src="../../assets/js/vendor/highlight.js"></script>
  </body>
</html>
